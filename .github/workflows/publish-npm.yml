name: Lerna Release & Publish

on:
    push:
        tags:
            - 'v*' # Trigger the workflow when a version tag is pushed (e.g., v1.0.0)

jobs:
    release:
        runs-on: ubuntu-latest # Use the latest Ubuntu for the environment

        steps:
            # Step 1: Checkout the repository
            - name: Checkout code
              uses: actions/checkout@v2

            # Step 2: Set up Node.js
            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: '20' # Specify the Node.js version to use

            # Step 3: Install dependencies
            - name: Install dependencies
              run: npm ci # Uses package-lock.json to ensure exact versions

            # Step 4: Run Lerna version to bump versions and create tags
            - name: Run Lerna Version
              run: npx lerna version --conventional-commits --yes # Automatically bump version using Conventional Commits

            # Step 5: Publish packages with Lerna
            - name: Publish packages
              run: npx lerna publish from-git --yes # Publish the packages with the new version

              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
